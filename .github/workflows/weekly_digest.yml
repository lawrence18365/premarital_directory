name: Weekly Profile Digest
on:
  schedule:
    # Monday 9 AM UTC (4 AM EST / 1 AM PST)
    # Counselors see it first thing Monday morning
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Send all emails to test_email instead of real recipients'
        required: false
        default: 'false'
      test_email:
        description: 'Test email address (only used if test_mode is true)'
        required: false
      max_emails:
        description: 'Max emails to send (default 200)'
        required: false
        default: '200'

jobs:
  send-digest:
    runs-on: ubuntu-latest
    steps:
      - name: Send Weekly Digest Emails
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          INTERNAL_API_KEY: ${{ secrets.INTERNAL_API_KEY }}
        run: |
          echo "Sending weekly digest emails..."

          BODY='{}'
          if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            BODY='{"test_mode": true, "test_email": "${{ github.event.inputs.test_email }}", "max_emails": ${{ github.event.inputs.max_emails || 200 }}}'
          else
            BODY='{"max_emails": ${{ github.event.inputs.max_emails || 200 }}}'
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${SUPABASE_URL}/functions/v1/send-weekly-digest" \
            -H "Content-Type: application/json" \
            -H "x-internal-api-key: ${INTERNAL_API_KEY}" \
            -d "${BODY}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY_RESPONSE=$(echo "$RESPONSE" | head -n -1)

          echo "Response (HTTP ${HTTP_CODE}):"
          echo "$BODY_RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$BODY_RESPONSE"

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "ERROR: Weekly digest failed with HTTP ${HTTP_CODE}"
            exit 1
          fi

          echo "Weekly digest complete!"
